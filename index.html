<html>
</html>
<head>
<style>
.board {
    width: 100%;
    height: 70%;
}
.dchart {
    width: 500px;
    height: 400px;
}
.history {
    height: 22%;
    overflow: scroll;
}
.draggable {
  width: 500px;
  height: 400px;
  border: 3px black solid;
  background: #ccc;
  position: relative;
}
.draggable.dragging {
  user-select: none;
}
.dragger {
  height: 30px;
  background: #555;
}
.closer {
  float: right;
}
/*.dragger::before {
  content: "window";
  color: #fff;
  margin: 5px;
  display: inline-block;
}*/
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
var socket;
var dispatchers = {};
var charts = {};
var hist = [];
var historyPos = 0;
function onReceiveTagged(tag, res)
{
    dispatchers[tag](tag, res);
}
function onReceive(txt)
{
    var reTagged = /\[[0-9]+:([^\]]+)\] (.*)/ ;
    var res = txt.match(reTagged);
    if (res != null && res[1]!='error')
    {
        //console.log(res);
        onReceiveTagged(res[1], res[2]);
    }
    else
    {
        document.getElementById('history').innerText += txt;
        var hc = document.getElementById('histCont');
        hc.scrollTop = hc.scrollHeight;
        console.log(txt);
    }
}
function connect(hp) {
    var hpl = hp.split(':');
    var host = hpl[0];
    var port = 54001
    if (hpl.length > 1)
        port = parseInt(hpl[1]);
    socket = new WebSocket("ws://" + host + ":" + port);
    socket.addEventListener("open", e => {});
    socket.addEventListener("message", e => {
            var pl = e.data;
            pl.text().then(txt => onReceive(txt));
            //console.log(pl);
    });
    socket.addEventListener('close', function close(code, reason) {
console.log('ws is closed with code: ' + code + ' reason: ' + reason);
console.log(code);
});

// On Error
socket.addEventListener('error', function(e) {
    console.log("error occured" +e);
});
}
function send(msg)
{
    socket.send(new TextEncoder().encode(msg));
}

var nextChannel = 1;
function show(varName)
{
    var cid = nextChannel;
    nextChannel++;
    var cn = "c_" + cid;
    var tn = "t_" + cid;
    send('var ' + cn + ' = Channel.new("'+cn+'");');
    send('var ' + tn + ' = Tag.new();');
    dispatchers[cn] = function(tag, res) {
        document.getElementById(tag).innerText = res;
    };
    d = document.createElement('div');
    d.classList.add("draggable");
    d.innerHTML = '<div class="dragger">'+varName+'<div class="closer" onclick="closeWidget(event)">X&nbsp;&nbsp;</div></div><span id="'+cn+'"></div>';
    makeResizable(d);
    document.getElementById('board').appendChild(d); // innerHTML += '<div class="draggable"><div class="dragger">'+varName+'</div><span id="'+cn+'"></div></div>';
    send(tn+':every(100ms) ' + cn + ' << ' + varName +',');
}

function closeWidget(event)
{
    var d = event.target;
    var id = d.parentElement.parentElement.children[1].id;
    var tn = 't' + id.substr(1);
    send(tn + ".stop();");
    d.parentElement.parentElement.remove();
}

dChart = null;
function graph(varName)
{
    var cid = nextChannel;
    nextChannel++;
    var cn = "c_" + cid;
    var tn = "t_" + cid;
    send('var ' + cn + ' = Channel.new("'+cn+'");');
    send('var ' + tn + ' = Tag.new();');
    var chart = null;
    dispatchers[cn] = function(tag, res) {
        chart.data.labels.push(chart.data.labels.length);
        chart.data.datasets[0].data.push(parseFloat(res));
        if (chart.data.labels.length > 200)
        {
            chart.data.labels = chart.data.labels.slice(chart.data.labels.length-200);
            chart.data.datasets[0].data = chart.data.datasets[0].data.slice(chart.data.datasets[0].data.length-200);
        }
        chart.update();
    };
    d = document.createElement('div');
    d.classList.add("draggable");
    d.id = "c_" + cn;
    d.innerHTML = '<div class="dragger">'+varName+'<div class="closer" onclick="closeWidget(event)">X&nbsp;&nbsp;</div></div><canvas class="dchart" id="'+cn+'"></div>';
    document.getElementById('board').appendChild(d);
    //document.getElementById('board').innerHTML += '<div class="draggable" id="c_'+cn+'"><div class="dragger">'+varName+'</div><canvas class="dchart" id="'+cn+'"></div></div>';
    setTimeout(function() {
            makeResizable(document.getElementById('c_'+cn));
            chart = new Chart(document.getElementById(cn), {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [ {
                            label: 'v',
                            data: [],
                        }],
                    }
            });
            dChart = chart;
            send(tn + ': every(100ms) ' + cn + ' << ' + varName +',');
    }, 500);
}


var x, y, target = null;

document.addEventListener('mousedown', function(e) {
  var clickedDragger = false;
  var pth = e.composedPath();
  for(var i = 0; pth[i] !== document.body; i++) {
    if (pth[i].classList.contains('dragger')) {
      clickedDragger = true;
    }
    else if (clickedDragger && pth[i].classList.contains('draggable')) {
      target = pth[i];
      target.classList.add('dragging');
      x = e.clientX - target.style.left.slice(0, -2);
      y = e.clientY - target.style.top.slice(0, -2);
      return;
    }
  }
});

document.addEventListener('mouseup', function() {
  if (target !== null) target.classList.remove('dragging');
  target = null;
});

document.addEventListener('mousemove', function(e) {
  if (target === null) return;
  target.style.left = e.clientX - x + 'px';
  target.style.top = e.clientY - y + 'px';
  var pRect = target.parentElement.getBoundingClientRect();
  var tgtRect = target.getBoundingClientRect();  if (tgtRect.left < pRect.left) target.style.left = 0;
  if (tgtRect.top < pRect.top) target.style.top = 0;
  if (tgtRect.right > pRect.right) target.style.left = pRect.width - tgtRect.width + 'px';
  if (tgtRect.bottom > pRect.bottom) target.style.top = pRect.height - tgtRect.height + 'px';
});



function makeResizable(element, minW = 100, minH = 100, size = 20)
{
    const top = document.createElement('div');
    top.style.width = '100%';
    top.style.height = size + 'px';
    top.style.backgroundColor = 'transparent';
    top.style.position = 'absolute';
    top.style.top = - (size/2) + 'px';
    top.style.left = '0px';
    top.style.cursor = 'n-resize';

    top.addEventListener('mousedown',resizeYNegative())

    element.appendChild(top);

    const bottom = document.createElement('div');
    bottom.style.width = '100%';
    bottom.style.height = size + 'px';
    bottom.style.backgroundColor = 'transparent';
    bottom.style.position = 'absolute';
    bottom.style.bottom = - (size/2) + 'px';
    bottom.style.left = '0px';
    bottom.style.cursor = 'n-resize';

    bottom.addEventListener('mousedown',resizeYPositive())

    element.appendChild(bottom);

    const left = document.createElement('div');
    left.style.width = size + 'px';
    left.style.height = '100%';
    left.style.backgroundColor = 'transparent';
    left.style.position = 'absolute';
    left.style.top = '0px';
    left.style.left = - (size/2) + 'px';
    left.style.cursor = 'e-resize';

    left.addEventListener('mousedown',resizeXNegative())

    element.appendChild(left);

    const right = document.createElement('div');
    right.style.width = size + 'px';
    right.style.height = '100%';
    right.style.backgroundColor = 'transparent';
    right.style.position = 'absolute';
    right.style.top = '0px';
    right.style.right = - (size/2) + 'px';
    right.style.cursor = 'e-resize';

    right.addEventListener('mousedown',resizeXPositive())

    element.appendChild(right);


    const corner1 = document.createElement('div');
    corner1.style.width = size + 'px';
    corner1.style.height = size + 'px';
    corner1.style.backgroundColor = 'transparent';
    corner1.style.position = 'absolute';
    corner1.style.top = - (size/2) + 'px';
    corner1.style.left = - (size/2) + 'px';
    corner1.style.cursor = 'nw-resize';

    corner1.addEventListener('mousedown',resizeXNegative())
    corner1.addEventListener('mousedown',resizeYNegative())
    
    element.appendChild(corner1);

    const corner2 = document.createElement('div');
    corner2.style.width = size + 'px';
    corner2.style.height = size + 'px';
    corner2.style.backgroundColor = 'transparent';
    corner2.style.position = 'absolute';
    corner2.style.top = - (size/2) + 'px';
    corner2.style.right = - (size/2) + 'px';
    corner2.style.cursor = 'ne-resize';

    corner2.addEventListener('mousedown',resizeXPositive())
    corner2.addEventListener('mousedown',resizeYNegative())

    element.appendChild(corner2);

    const corner3 = document.createElement('div');
    corner3.style.width = size + 'px';
    corner3.style.height = size + 'px';
    corner3.style.backgroundColor = 'transparent';
    corner3.style.position = 'absolute';
    corner3.style.bottom = - (size/2) + 'px';
    corner3.style.left = - (size/2) + 'px';
    corner3.style.cursor = 'sw-resize';

    corner3.addEventListener('mousedown',resizeXNegative())
    corner3.addEventListener('mousedown',resizeYPositive())

    element.appendChild(corner3);

    const corner4 = document.createElement('div');
    corner4.style.width = size + 'px';
    corner4.style.height = size + 'px';
    corner4.style.backgroundColor = 'transparent';
    corner4.style.position = 'absolute';
    corner4.style.bottom = - (size/2) + 'px';
    corner4.style.right = - (size/2) + 'px';
    corner4.style.cursor = 'se-resize';

    corner4.addEventListener('mousedown',resizeXPositive())
    corner4.addEventListener('mousedown',resizeYPositive())

    element.appendChild(corner4);
    
    function get_int_style(key)
    {
        return parseInt(window.getComputedStyle(element).getPropertyValue(key));
    }

    function resizeXPositive()
    {
        let offsetX
        function dragMouseDown(e) {
            if(e.button !== 0) return
            e = e || window.event;
            e.preventDefault();
            const {clientX} = e;
            offsetX = clientX - element.offsetLeft - get_int_style('width');
            document.addEventListener('mouseup', closeDragElement)
            document.addEventListener('mousemove', elementDrag)
          }
        
          function elementDrag(e) {
                const {clientX} = e;
                let x = clientX - element.offsetLeft - offsetX
                if(x < minW) x = minW;
                element.style.width =  x + 'px';
          }
        
          function closeDragElement() {
            document.removeEventListener("mouseup", closeDragElement);  
            document.removeEventListener("mousemove", elementDrag);
          }
        return dragMouseDown
    }

    function resizeYPositive()
    {
        let offsetY
        function dragMouseDown(e) {
            if(e.button !== 0) return
            e = e || window.event;
            e.preventDefault();
            const {clientY} = e;
            offsetY = clientY - element.offsetTop - get_int_style('height');
    
            document.addEventListener('mouseup',closeDragElement)
            document.addEventListener('mousemove',elementDrag)
          }
        
          function elementDrag(e) {
                const {clientY} = e;
                let y =  clientY - element.offsetTop - offsetY;
                if(y < minH) y = minH;
                element.style.height = y + 'px';
          }
        
          function closeDragElement() {
            document.removeEventListener("mouseup", closeDragElement);  
            document.removeEventListener("mousemove", elementDrag);
          }
        return dragMouseDown
    }

    function resizeXNegative()
    {
        let offsetX
        let startX
        let startW
        let maxX
        function dragMouseDown(e) {
            if(e.button !== 0) return
            e = e || window.event;
            e.preventDefault();
            const {clientX} = e;
            startX = get_int_style('left')
            startW = get_int_style('width')
            offsetX = clientX - startX;
            maxX = startX + startW - minW
    
            document.addEventListener('mouseup',closeDragElement)
            document.addEventListener('mousemove',elementDrag)
          }
        
          function elementDrag(e) {
                const {clientX} = e;
                let x = clientX - offsetX
                let w = startW + startX - x
                if(w < minW) w = minW;
                if(x > maxX) x = maxX;
                element.style.left = x + 'px';
                element.style.width = w + 'px';
          }
        
          function closeDragElement() {
            document.removeEventListener("mouseup", closeDragElement);  
            document.removeEventListener("mousemove", elementDrag);
          }
        return dragMouseDown
    }

    function resizeYNegative()
    {
        let offsetY
        let startY
        let startH
        let maxY
        function dragMouseDown(e) {
            if(e.button !== 0) return
            e = e || window.event;
            e.preventDefault();
            const {clientY} = e;
            startY = get_int_style('top')
            startH = get_int_style('height')
            offsetY = clientY - startY;
            maxY = startY + startH - minH 
    
            document.addEventListener('mouseup',closeDragElement,false)
            document.addEventListener('mousemove',elementDrag,false)
          }
        
          function elementDrag(e) {
                const {clientY} = e;
                let y =  clientY - offsetY
                let h = startH + startY - y
                if(h < minH) h = minH;
                if(y > maxY) y = maxY;
                element.style.top = y + 'px';
                element.style.height = h + 'px';
          }
        
          function closeDragElement() {
            document.removeEventListener("mouseup", closeDragElement);  
            document.removeEventListener("mousemove", elementDrag);
          }
        return dragMouseDown
    }
}
function processCommand(cmd)
{
    if (!socket)
        connect(cmd);
    else if (cmd[0] == '#')
    {
        var s = cmd.indexOf(' ');
        var rcmd = cmd.substr(1, s-1);
        var args = cmd.substr(s+1);
        if (rcmd == 'show')
            show(args);
        else if (rcmd == 'graph')
            graph(args);
        else if (rcmd == 'connect')
            connect(args);
        else if (rcmd == 'watch')
        {
            var wargs = args.split('@');
            var wid = nextChannel;
            nextChannel++;
            var wvar = wargs[0];
            var wexp = wargs[1];
            var tname = 't_'+wid;
            var cname = 'c_'+wid;
            dispatchers[cname] = function(c, v) {
                var remain = wargs.splice(2);
                for (var i in remain)
                {
                    processCommand(remain[i].trim());
                }
            };
            send(`var ${cname} = Channel.new("${cname}");
                var ${tname} = Tag.new();
                ${tname}: every(1s) try { 
                    var hit = ${wexp};
                    var Lobby.lobby.${wvar} = hit;
                    ${cname} << true;
                    ${tname}.stop();
                } catch(var e) {},
                `);
        }
    }
    else
        send(cmd + "\n");
}

function onLoad()
{
    document.getElementById('tCmd').addEventListener('keydown', function(ev) {
            if (ev.key === 'Enter' || ev.keyCode === 13)
            {
                cmd = document.getElementById('tCmd').value;
                processCommand(cmd);
                document.getElementById('tCmd').value = '';
                console.log(history);
                if (hist[hist.length-1] != cmd)
                    hist.push(cmd);
                historyPos = hist.length;
            }
            else if (ev.keyCode === 38) { //up
                if (historyPos > 0)
                {
                    historyPos--;
                    document.getElementById('tCmd').value = hist[historyPos];
                }
            }
            else if (ev.keyCode == 40) { //down
               if (historyPos < history.length - 1)
               {
                   historyPos++;
                   document.getElementById('tCmd').value = hist[historyPos];
               }
            }
    });
}
</script>
</head>
<body onload="onLoad()">
<div id="board" class="board"></div>
<div class="history" id="histCont">
<pre id="history"></pre>
</div>
<div id="command" class="command">
   <input type="text" id="tCmd" class="commandText" placeholder="#show #graph or urbiscript">
</div>
</body>
</html>